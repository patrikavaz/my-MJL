name: Monitor Liara.ir JS Changes

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create folders
        run: mkdir -p chunks/pages chunks

      - name: Download list of pages JS
        run: |
          curl -s https://liara.ir/_next/static/chunks/pages/ > pages.html
          grep -o 'href="[^"]*\.js"' pages.html | cut -d'"' -f2 > pages_list.txt

      - name: Download list of main chunks
        run: |
          curl -s https://liara.ir/_next/static/chunks/ > chunks.html
          grep -o 'href="[^"]*\.js"' chunks.html | cut -d'"' -f2 > chunks_list.txt

      - name: Download ALL JS files
        run: |
          cat pages_list.txt chunks_list.txt | sort -u | while read file; do
            url="https://liara.ir/_next/static/chunks/$file"
            if [[ "$file" == pages/* ]]; then
              out="chunks/pages/${file#pages/}"
            else
              out="chunks/$file"
            fi
            mkdir -p "$(dirname "$out")"
            echo "↓ $url"
            curl -f -L "$url" -o "$out" && echo "✓ $file"
          done

      - name: Beautify (خوانا کن!)
        run: |
          npm install -g js-beautify
          find chunks -name "*.js" -exec js-beautify -r {} \;

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Liara.ir JS updated $(date +'%Y-%m-%d %H:%M')"
          file_pattern: chunks
