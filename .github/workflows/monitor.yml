name: Monitor Liara.ir JS Changes

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create folders
        run: mkdir -p chunks/pages chunks/webpack

      - name: Download build manifest (لیست همه JSها)
        run: |
          curl -s https://liara.ir/_next/static/$(curl -s https://liara.ir | grep -o '"buildId":"[^"]*"' | cut -d'"' -f4)/buildManifest.js > buildManifest.js

      - name: Extract ALL JS paths from manifest
        run: |
          grep -o '/_next/static/[^"]*\.js' buildManifest.js | sort -u > js-list.txt

      - name: Download every JS file
        run: |
          cat js-list.txt | while read path; do
            url="https://liara.ir$path"
            file="./chunks${path#_next/static}"
            mkdir -p "$(dirname "$file")"
            echo "↓ $url"
            curl -f -L --create-dirs "$url" -o "$file" || echo "✘ Failed: $url"
          done

      - name: Beautify JS (خوانا کن!)
        run: |
          npx js-beautify@latest -r "chunks/**/*.js" || true

      - name: Commit فقط اگر تغییر کرد
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Liara.ir JS updated $(date)"
          file_pattern: chunks
